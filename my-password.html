<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>修改密碼</title>
    <link rel="stylesheet" href="assets/ui.css" />
</head>

<body>
    <header class="topbar">
        <div class="topbar-inner">
            <div class="brand">
                <h1>工單系統</h1>
                <span class="tag">修改密碼</span>
            </div>
            <div class="row" style="margin:0;">
                <a class="btn secondary" href="index.html">回主選單</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="card">
            <h2>修改密碼</h2>

            <div class="field">
                <label>舊密碼</label>
                <input id="oldPassword" type="password" autocomplete="current-password" />
            </div>

            <div class="field">
                <label>新密碼</label>
                <input id="newPassword" type="password" placeholder="至少 6 碼" autocomplete="new-password" />
            </div>

            <div class="field">
                <label>確認新密碼</label>
                <input id="newPassword2" type="password" placeholder="再輸入一次新密碼" autocomplete="new-password" />
            </div>

            <div class="row">
                <button id="saveBtn">更新密碼</button>
                <span id="msg" class="msg"></span>
            </div>

            <div class="kbd" style="margin-top:10px;">
                若忘記密碼，需由 ADMIN 協助重設。
            </div>
        </section>
    </main>

    <script type="module">
        import { api, logout } from "./assets/api.js";
        import { guardPage } from "./assets/guard.js";

        guardPage({
            allowRoles: ["USER", "AGENT", "ADMIN"],
            title: "修改我的密碼",
            hint: "此頁允許 USER / AGENT / ADMIN 修改自己的密碼。"
        });

        const msg = document.getElementById("msg");

        document.getElementById("saveBtn").addEventListener("click", async () => {
            msg.textContent = "";

            const oldPassword = document.getElementById("oldPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const newPassword2 = document.getElementById("newPassword2").value;

            if (!oldPassword || !newPassword || !newPassword2) {
                msg.textContent = "請填寫舊密碼、新密碼與確認新密碼";
                return;
            }
            if (newPassword.length < 6) {
                msg.textContent = "新密碼至少 6 碼";
                return;
            }
            if (newPassword !== newPassword2) {
                msg.textContent = "兩次新密碼不一致，請重新確認";
                return;
            }

            try {
                await api("/api/auth/me/password", {
                    method: "PUT",
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                // ✅ 成功提示
                msg.textContent = "密碼更新成功，請使用新密碼重新登入…";

                // ✅ 1. 稍等 1.5 秒讓使用者看到訊息
                setTimeout(() => {
                    // ✅ 2. 清除 token / session
                    logout();

                    // ✅ 3. 導回登入頁
                    location.href = "login.html";
                }, 1500);

            } catch (e) {
                msg.textContent = e.message;
            }
        });

    </script>
</body>

</html>